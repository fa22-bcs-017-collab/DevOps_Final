---
# Main Ansible Playbook for DevOps Infrastructure Setup
# This playbook configures servers for the Task Manager application

- name: Configure Web Servers (Frontend)
  hosts: webservers
  become: yes
  vars:
    nginx_version: latest
    app_user: webapp
    app_directory: /var/www/taskmanager
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [setup, update]

    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
        state: present
      tags: [setup, packages]

    - name: Install Nginx web server
      apt:
        name: nginx
        state: present
      tags: [nginx, webserver]

    - name: Start and enable Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes
      tags: [nginx, webserver]

    - name: Configure firewall for HTTP/HTTPS
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'
      tags: [firewall, security]

    - name: Create application user
      user:
        name: "{{ app_user }}"
        state: present
        shell: /bin/bash
        createhome: yes
      tags: [setup, users]

    - name: Create application directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      tags: [setup, directories]

    - name: Copy Nginx configuration
      template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/sites-available/taskmanager
      notify: Reload Nginx
      tags: [nginx, config]

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/taskmanager
        dest: /etc/nginx/sites-enabled/taskmanager
        state: link
      notify: Reload Nginx
      tags: [nginx, config]

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload Nginx
      tags: [nginx, config]

  handlers:
    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded

- name: Configure Application Servers (Backend)
  hosts: appservers
  become: yes
  vars:
    nodejs_version: "18.x"
    app_user: nodeapp
    app_directory: /opt/taskmanager
    app_port: 3000
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [setup, update]

    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - vim
          - htop
        state: present
      tags: [setup, packages]

    - name: Add NodeSource repository
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }} | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
      tags: [nodejs, setup]

    - name: Install Node.js and npm
      apt:
        name:
          - nodejs
        state: present
      tags: [nodejs, packages]

    - name: Verify Node.js installation
      command: node --version
      register: node_version
      changed_when: false
      tags: [nodejs, verify]

    - name: Display Node.js version
      debug:
        msg: "Node.js version: {{ node_version.stdout }}"
      tags: [nodejs, verify]

    - name: Install PM2 process manager globally
      npm:
        name: pm2
        global: yes
        state: present
      tags: [nodejs, pm2]

    - name: Create application user
      user:
        name: "{{ app_user }}"
        state: present
        shell: /bin/bash
        createhome: yes
      tags: [setup, users]

    - name: Create application directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      tags: [setup, directories]

    - name: Configure firewall for application port
      ufw:
        rule: allow
        port: "{{ app_port }}"
        proto: tcp
      tags: [firewall, security]

    - name: Create environment file
      template:
        src: templates/app.env.j2
        dest: "{{ app_directory }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'
      tags: [config, environment]

    - name: Set up log rotation
      copy:
        dest: /etc/logrotate.d/taskmanager
        content: |
          {{ app_directory }}/logs/*.log {
              daily
              missingok
              rotate 14
              compress
              delaycompress
              notifempty
              create 0640 {{ app_user }} {{ app_user }}
              sharedscripts
          }
      tags: [logging, maintenance]

- name: Configure Docker Hosts
  hosts: dockerhosts
  become: yes
  vars:
    docker_users:
      - ubuntu
      - {{ ansible_user }}
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [setup, update]

    - name: Install required packages for Docker
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
        state: present
      tags: [docker, setup]

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: [docker, setup]

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      tags: [docker, setup]

    - name: Install Docker CE
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes
      tags: [docker, packages]

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      tags: [docker, service]

    - name: Add users to docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users }}"
      tags: [docker, users]

    - name: Install Docker Compose (standalone)
      get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      tags: [docker, compose]

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false
      tags: [docker, verify]

    - name: Display Docker version
      debug:
        msg: "Docker version: {{ docker_version.stdout }}"
      tags: [docker, verify]

    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: compose_version
      changed_when: false
      tags: [docker, verify]

    - name: Display Docker Compose version
      debug:
        msg: "Docker Compose version: {{ compose_version.stdout }}"
      tags: [docker, verify]

    - name: Configure Docker daemon
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2"
          }
      notify: Restart Docker
      tags: [docker, config]

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted

- name: System Hardening and Security
  hosts: all
  become: yes
  
  tasks:
    - name: Update all packages
      apt:
        upgrade: dist
        update_cache: yes
      tags: [security, updates]

    - name: Install security packages
      apt:
        name:
          - ufw
          - fail2ban
          - unattended-upgrades
        state: present
      tags: [security, packages]

    - name: Enable UFW firewall
      ufw:
        state: enabled
        policy: deny
      tags: [security, firewall]

    - name: Allow SSH through firewall
      ufw:
        rule: allow
        port: '22'
        proto: tcp
      tags: [security, firewall]

    - name: Configure automatic security updates
      copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
          };
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::MinimalSteps "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "false";
      tags: [security, updates]

    - name: Set timezone to UTC
      timezone:
        name: UTC
      tags: [system, config]

    - name: Configure NTP for time synchronization
      apt:
        name: ntp
        state: present
      tags: [system, time]

- name: Monitoring and Logging Setup
  hosts: all
  become: yes
  
  tasks:
    - name: Install monitoring tools
      apt:
        name:
          - htop
          - iotop
          - nethogs
          - sysstat
        state: present
      tags: [monitoring, tools]

    - name: Enable sysstat
      lineinfile:
        path: /etc/default/sysstat
        regexp: '^ENABLED='
        line: 'ENABLED="true"'
      tags: [monitoring, config]

    - name: Start sysstat service
      systemd:
        name: sysstat
        state: started
        enabled: yes
      tags: [monitoring, service]

- name: Generate Deployment Report
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - name: Create report directory
      file:
        path: ./reports
        state: directory
      tags: [reporting]

    - name: Generate deployment summary
      copy:
        dest: ./reports/deployment-summary-{{ ansible_date_time.date }}.txt
        content: |
          ===============================================
          Ansible Deployment Report
          ===============================================
          Date: {{ ansible_date_time.iso8601 }}
          
          Configured Servers:
          - Web Servers: {{ groups['webservers'] | length }}
          - App Servers: {{ groups['appservers'] | length }}
          - Docker Hosts: {{ groups['dockerhosts'] | length }}
          
          Deployment Status: SUCCESS
          ===============================================
      tags: [reporting]
